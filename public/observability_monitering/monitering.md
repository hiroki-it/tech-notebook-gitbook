# 監視

## はじめに

本サイトにつきまして，以下をご認識のほど宜しくお願いいたします．

参考：https://hiroki-it.github.io/tech-notebook-gitbook/

<br>

## 01. 監視

### 監視とは

既知のメトリクスとログに基づいて，システムにおける想定内の不具合の発生を未然に防ぐこと．想定内という点で，可観測性と区別できる．

参考：

- https://en.wikipedia.org/wiki/Website_monitoring
- https://blog.thundra.io/observability-driven-development-for-serverless

<br>

### 監視の要素

監視は，以下の要素からなる．

参考：https://www.amazon.co.jp/dp/4873118646

| アクション     | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| データの収集   | 監視対象からデータを収集する．データとしては，メトリクス，アプリケーションログ，ブラウザログ，ユーザトラフィック，などがある． |
| ↓              | 収集後，次のアクションに分岐する．                           |
| データの保管   | データをストレージに保管する．                               |
| データの可視化 | データを監視ダッシュボードに表示し，目視できるようにする．   |
| データの分析   | データを数学的に分析し，結果を算出する．                     |
| レポートの作成 | 算出値をグラフ化として，レポートを作成する．                 |
| アラート       | データに異常がある場合，これをインシデントとして開発者に通知する．SLAに満たない場合，サービス利用者に利用料を返金する．また，インシデントを解決するためのタスクを作成し，これに対応する． |

<br>

### フロントエンド監視

#### ・フロントエンド監視とは

ブラウザに関するトラフィックを監視する．

#### ・リアルユーザ監視（RUM）

ブラウザは，Webページのロード時に，Navigation-timing-APIに対してリクエストを送信し，Webページパフォーマンスに関するメトリクスを収集する．リアルユーザ監視では，このメトリクスを監視する．

参考：https://developer.mozilla.org/ja/docs/Web/API/Navigation_timing_API

ページロード時間は特に重要である．Amazonの自社調査では，ロード時間が100ms短くなるごとに，売り上げが```1```%増加することが明らかになった．```4```秒以下を目指すと良い．

参考：https://bit.ly/2y494hq

#### ・合成監視（外部監視）

『外部監視』ともいう．SaaSは，実際のユーザの一連の操作を模したリクエストをアプリケーションに送信し，レスポンスに関するメトリクスを収集する．合成監視では，メトリクスを監視する．ユーザを模したリクエストを生成するという意味合いで，『合成』という．ユーザ視点で監視できる．

参考：

- https://takehora.hatenadiary.jp/entry/2019/07/05/012036
- https://www.manageengine.jp/products/Applications_Manager/solution_synthetic-monitoring.html

<br>

### アプリケーション監視（APM）

#### ・アプリケーション監視とは

『APM（アプリケーションパフォーマンス監視）』ともいう．アプリケーション内に常駐させたSaaSエージェントは，サーバ内で稼働中のアプリケーションのメトリクスやアプリケーションログを収集し，SaaSに送信する．アプリケーション監視では，これらのメトリクスやアプリケーションログを監視する．メトリクスの例は以下に示す．

- SQLにかかる時間  
- ビルドまたはデプロイの開始／終了時間  
- 外部APIコールにかかる時間  
- リクエストの受信数  
- ログイン数  

#### ・StatsDを用いたメトリクスの作成

サーバ内にStatsDを常駐させ，アプリケーションでStatsDライブラリを用いると，メトリクスを収集できる．このメトリクスをSaaSに送信する．

参考：https://github.com/statsd/statsd/wiki

CloudWatchではStatsDからのメトリクスの送信がサポートされている．

参考：

- https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-custom-metrics-statsd.html
- https://qiita.com/murata-tomohide/items/9bd1320865b2eba47538

<br>

### サーバ／コンテナ監視

#### ・サーバ／コンテナ監視とは

サーバ／コンテナのOSに関するメトリクスを収集し，これをSaaSに送信する．サーバ／コンテナ監視では，このメトリクスを監視する．メトリクスの例は以下に示す．

- CPU
- メモリ
- ロードアベレージ
- ネットワーク
- ディスク

<br>

### ネットワーク監視

<br>

### セキュリティ監視

<br>

## 02. ポストモーテムの作成

###  ポストモーテムとは

アラートで通知されたインシデントがビジネスに大きな影響を与えた場合，振り返りのために，ポストモーテムを作成する．ポストモーテムは，障害報告書とは異なり，原因特定とシステム改善に重きを置いた報告書である．障害報告書は，責任の報告の意味合いが強くなってしまう．

<br>

### テンプレート

参考：https://ueokande.github.io/incident-response-docs-ja/after/post_mortem_template/

```markdown
# ポストモーテム

## タイトル

## 日付

## 担当者

**※担当者を絶対に責めず，障害は誰のせいでもないという意識を強く持つ．**

## 原因と対応

**※原因特定とシステム改善に重きを置くこと．**

## システム的/収益的な影響範囲

## 幸運だったこと

## 仕組みの改善策

**※「以後は注意する」ではなく，再発しない仕組み作りになるようにする．**

## 障害発生から対応までのタイムライン

```

<br>

### 他社事例

参考：https://ueokande.github.io/incident-response-docs-ja/after/post_mortem_process/#_6

| サービス | リンク                                                       |
| -------- | ------------------------------------------------------------ |
| AWS      | https://aws.amazon.com/jp/message/5467D2/                    |
| Heroku   | https://status.heroku.com/incidents/151                      |
| Twilio   | https://www.twilio.com/blog/2013/07/billing-incident-post-mortem-breakdown-analysis-and-root-cause.html |

<br>

## 03. 監視に基づく意思決定

### SLI：Service Level Indicator（サービスレベル指標）

#### ・SLIとは

サービスレベルの指標とするメトリクスのこと．

#### ・SLIの例

- サーバ稼働率
- データベース稼働率
- レイテンシー
- レスポンスタイム
- レスポンスのステータスコード率
- スループット

<br>

### AWSで役立つメトリクス

#### ・SLIに関連するメトリクス

| 指標                           | AWSリリース | 関連するメトリクス                                           | 補足                                                         |
| ------------------------------ | ----------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| サーバ稼働率                   | ECS         | ・```RunningTaskCount```                                     | ターゲット追跡スケーリングポリシーのECSサービスメトリクスも参考にせよ． |
| データベース稼働率             | RDS         | ・```CPUUtilization```<br>・```FreeableMemory```             |                                                              |
| レイテンシー                   | API Gateway | ・```Latency```<br>・```IntegrationLatency```                |                                                              |
| レスポンスのステータスコード率 | API Gateway | ・```4XXError```<br>・```5XXError```                        |                                                              |
|                                | ALB         | ・```HTTPCode_ELB_4XX_Count```<br>・```HTTPCode_ELB_5XX_Count```<br>・```HTTPCode_TARGET_4XX_Count```<br>・```HTTPCode_TARGET_5XX_Count```<br>・```RejectedConnectionCount```<br>・```HealthyHostCount```<br>・```TargetConnectionErrorCount```<br>・```TargetTLSNegotiationErrorCount``` | 参考：https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/load-balancer-cloudwatch-metrics.html |

#### ・パフォーマンスに関するメトリクス

| 名前                     | AWSリリース | 補足                                                         |
| ------------------------ | ----------- | ------------------------------------------------------------ |
| パフォーマンスインサイト | RDS         | RDSのパフォーマンスに関するメトリクスを収集し，SQLレベルで監視できるようになる．パラメータグループの```performance_schema```を有効化する必要がある．対応するエンジンバージョンとインスタンスタイプについては，以下のリンクを参考にせよ．<br>参考：https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/USER_PerfInsights.Overview.Engines.htm |
| Container インサイト     | ECS／EKS    | ECS／EKSのパフォーマンスに関するメトリクスを収集し，ECS／EKSのクラスター，サービス，タスク，インスタンス，単位で監視できるようになる．また，コンテナ間の繋がりをコンテナマップで視覚化できるようになる．ECS／EKSのアカウント設定でContainerインサイトを有効化する必要がある． |
| Lambdaインサイト         | Lambda      | Lambdaのパフォーマンスに関するメトリクスを収集できるようになる． |

<br>

### SLO：Service Level Objective（サービスレベル目標）

#### ・SLOとは

SLIとして採用した指標の目標値のこと．ユーザの視点で設定する必要がある．99.9%の成功率を目標とすることが多い．

#### ・SLOの例

| 指標                           | 目標値の例                                   |
| ------------------------------ | -------------------------------------------- |
| サーバ稼働率                   | 日当たり```0.1```%以下のダウンタイム         |
| データベース稼働率             | 日当たり```0.1```%以下のダウンタイム         |
| レイテンシー                   | 日当たり```0.1```%以下のレイテンシー         |
| レスポンスのステータスコード率 | 日当たり```99.9```%以上の200ステータスコード |
| スループット                   | 日当たり```0.1```%以下のスループット低下     |

<br>

### エラーバジェット

#### ・エラーバジェットとは

年月当たりで許容するエラーやダウンタイムの程度のこと．エラーやダウンタイムの発生によってビジネスに影響を与える可能性があったとしても，SLOの閾値を超えない限りはこれを許容し，技術を優先する．ビジネスより技術を優先する時に，素早く意思決定できる．

<br>

### SLA：Service Level Agreement

#### ・SLAとは

サービスレベル合意と訳せる．インターネットサービスに最低限のサービスのレベルを保証し，これを下回った場合には返金できるように合意するもの．SLAとして，例えば以下がある．

| 項目             | 説明                                 | レベル例                | 返金率    |
| ---------------- | ------------------------------------ | ----------------------- | --------- |
| サーバ稼働率     | サーバの時間当たりの稼働率           | ```99.9```%以上         | ```10```% |
| 障害回復時間     | 障害が起こってから回復するまでの時間 | ```2```時間以内         | ```10```% |
| 障害お問い合わせ | 障害発生時のお問い合わせ可能時間帯   | ```24```時間```365```日 | ```10```% |

#### ・AWSのSLA

AWSではサービスレベルの項目として，サーバ稼働率を採用している．これに対して，ほとんどのAWSリソースで，以下のSLAが設定されている．各リソースにSLAが定義されている．

参考：https://aws.amazon.com/jp/legal/service-level-agreements/

**＊例＊**

EC2，EBS，ECS，EKS，の例を示す．

| 毎月の稼働率                       | 発生したダウンタイム        | 返金率     |
| ---------------------------------- | --------------------------- | ---------- |
| ```99.0```％以上，```99.99```%未満 | ```87.6```～```0.876```時間 | ```10```%  |
| ```95.0```％以上，```99.0```％未満 | ```438```～```87.6```時間   | ```30```%  |
| ```95.0```%未満                    | ```438```時間以上           | ```100```% |

