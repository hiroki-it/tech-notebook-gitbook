# OSI参照モデル／TCP階層モデル

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

参考：https://hiroki-it.github.io/tech-notebook-gitbook/

<br>

## 01. OSI参照モデルとTCP階層モデル

### データがパケットになるまで

1. アプリケーション層でデータが作成される。
2. トランスポート層でTCPヘッダが追加される。
3. インターネット層でIPヘッダが追加される。
4. ネットワークインターフェース層でEthernetヘッダが追加される。
5. パケットとして送信される。

![パケットの構造](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/パケットの構造.jpg)

<br>

### OSI参照モデル

#### ・各概念層のヘッダ情報追加

![OSI参照モデル](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/OSI参照モデル.png)

<br>

### TCP階層モデル

#### ・プロトコルの分類と扱われる階層

TCP/IPモデルで用いられるプロトコルのうち、最も代表的な『TCP』と『IP』から名前をとって『TCP/IP』と名付けられた。プロトコルとしての暗号化技術である『セキュアプロトコル』は、赤色で示してある。

![セキュアプロトコル](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/セキュアプロトコル.png)

<br>

## 02-02. 通信機器におけるヘッダ情報認識

### 各概念層と通信機器の間の対応関係

1. プライベートネットワークにクライアントPCがある。
2. クライアントPCにて、WebブラウザのアプリケーションのプロセスがTCPアプリケーション層（OSIアプリケーション層＋プレゼンテーション層＋セッション層）で稼働している。ここで、パケットが作成される。
3. パケットは、クライアントPCのTCPトランスポート層（OSIトランスポート層）、TCPインターネット層（OSIネットワーク層）、TCPネットワークインターフェース層（OSIデータリンク層＋OSI物理層）を経る。各層で、パケットにヘッダー情報が追加される。
4. PCからルータにパケットが送信される。
5. ルータはTCPインターネット層（OSIネットワーク層）に属するため、より上層に一度戻ることになる。
6. グローバルネットワークを経て、送信先のプライベートネットワークのルータに到達する。
7. ルータからサーバにパケットが送信される。
8. パケットは、サーバのCPネットワークインターフェース層（OSIデータリンク層＋OSI物理層）、TCPインターネット層（OSIネットワーク層）、TCPトランスポート層（OSIトランスポート層）、を経る。
9. サーバにて、アプリケーションのプロセスが特定のポート番でリッスンしている。アプリケーションによってパケットが処理される。

![OSI参照モデルと通信機器.png](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/OSI参照モデルと通信機器.jpg)

#### ・ネットワーク層

#### ・データリンク層

#### ・物理層

NIC：Network Interface Card（例：LANアダプタ、LANボード、LANカード）、リピータ、LANケーブル

<br>

### 各概念層のヘッダ情報認識

送信元で作成されたパケットは、非カプセル化されながら、通信機器に認識される。

参考：https://ja.wikipedia.org/wiki/%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC

![tcp-ip_structure](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/tcp-ip_structure.png)

<br>

## 03. TCPアプリケーション層

### アプリケーション層とは

各アプリケーションがプロセスとして稼働しており、それぞれがデータ（メッセージ）を作成する。各プロセスは特定のポート番号をリッスンする。

参考：https://netdekagaku.com/netstat-command/

![application_expose-port](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/application_expose-port.png)

ちなみに、指定したポート番号でリッスンしているプロセスを特定できる。

```bash
$ sudo lsof -i:<番号>
```

<br>

## 03-02. メールデータの作成

### メールデータの送受信

#### ・仕組み

1. クライアント（メール送信可能なアプリケーション）から送信されたメールは、送信側のメールサーバに送信される。
2. 送信側のメールサーバは、メールを受信側のメールサーバに転送する。
3. 受信側のアプリケーションは、各々が指定したプロトコルに応じて、受信側のメールサーバからメールデータを取得する。

参考：https://xtech.nikkei.com/it/pc/article/basic/20120312/1043605/

![smtp_pop3_imap4](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/smtp_pop3_imap4.png)

#### ・送信側のメールサーバのモック

メールデータの送信機能を開発するときに、送信テストを行う必要があり、この内容は公開したくない。そこで、送信側のメールサーバのモックを提供するサービスを利用する。この送信側メールサーバモックは、クライアントから送信されたメールのテストデータを受信側のメールサーバに転送しないため、安全に送信テストを実行できる。Mailtrapがおすすめである。

参考：https://mailtrap.io/

<br>

### SMTP：Simple Mail Transfer Protocol

#### ・SMTPとは

メールデータを送信するためのプロトコルのこと。

#### ・SMTP-AUTH：SMTP AUTHentication

SMTPに認証を組み込んだ仕組みのこと。クライアント（メール送信可能なアプリケーション）からメールサーバにメールデータをSMTP送信する時、メールサーバがクライアントに対して認証を実行する。

![SMTP-AUTH](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/SMTP-AUTH.png)

<br>

### POP3：Post Official Protocol version 3

#### ・POP3とは

メールサーバに届いたメールを、受信機器にダウンロードし、受信機器で閲覧するプロトコル。メールの既読未読状況は、他の受信機器と共有される。

<br>

### IMAP4：Internet Message Access Protocol version 4

#### ・IMAP4とは

メールサーバに届いたメールを、受信機器にダウンロードせず、メールサーバに置いたまま閲覧するプロトコル。メールの既読未読状況は、他の受信機器と共有されない。

  **＊例＊**

  GmailでPOPかIMAPを設定可能

![GmailでPOPorIMAPを設定](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/GmailでPOPかIMAPを設定.jpg)

<br>

### APOP：Authenticated POP

#### ・APOPとは

  メール受信の際に、チャレンジレスポンス方式の認証を行うことで平文の認証情報がネットワークに流れるのを防止するプロトコル

  <br>

## 04. TCPトランスポート層

### トランスポート層とは

#### ・全体像

クライアントからのリクエスト時に、ネットワーク層から渡されたパケットのポート番号情報を元に、アプリケーション層の特定のプロセスにパケットを渡す。また反対に、レスポンス時にアプリケーション層のプロセスから出力されたパケットに情報を付加し、ネットワーク層に渡す。この時、各アプリケーションはプロセスとして稼働していることに留意する。

![トランスポート層からアプリケーション層へのパケットの移動](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/トランスポート層からアプリケーション層へのパケットの移動.PNG)

#### ・クライアントからのリクエスト時（図の 『→』 ）

まず、ネットワーク層でプライベートIPアドレスを用いて、リクエスト先のパソコンを識別する。その後、トランスポート層で、ポート番号を元にして、アプリケーション層のプロセスにパケットを送信する。

**＊例＊**

ローカル環境のnginxプロセスのリッスンするポート番号を```8080```と設定した場合、リクエスト時に以下のようにポート番号を指定すると、nginxプロセスにリクエストを送信できる。

```http
GET http://localhost:8080/
```

#### ・クライアントへのレスポンス時（図の 『←』 ）

アプリケーション層から送信されてきたパケットの通過したポート番号をヘッダ情報として追加する。これを、ネットワーク層へ送信する。

#### ・ソケット、ソケット接続とは

トランスポート層に存在し、受信した通信をアプリケーション層の各プロセスに振り分ける受け口をソケットという。送信元のサーバが送信先に対して、『```192.168.1.1:50001```（送信元IPアドレス:送信ポート）』『```10.0.0.1:80```（宛先IPアドレス:宛先ポート）』といったように、IPアドレスとポート番号の組合せで指定する。オリジンとは似て非なるものなので注意。サーバ間のソケット間のネットワーク接続をソケット接続という。

<br>

### ポート番号

#### ・ポート番号とは

アプリケーションのプロセスへのパケット送受信に、プロセスを区別するために各プロセスに割り当てられる番号。アプリケーションには、それぞれポート番号が割り当てられており、トランスポート層で、ポート番号を元にして、特定のプロセスにパケットを送信する。

#### ・Well known ポート番号（0 ～ 1023）

IANA：Internet Assigned Numbers Authority（インターネット割当番号公社）によって管理されているポート番号。Webサーバがリクエストを受信する時、またレスポンスを送信する時に用いられる。ホストとゲスト（仮想サーバ）との通信では、80番（HTTP）の受信に関する様々な設定が必要になる。

![ポート番号とプロトコルの対応関係](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ポート番号とプロトコルの対応関係.png)

#### ・登録済みポート番号（1024 ～ 49151）

  IANAが登録申請を受けて公開しているポート番号。企業が作成した独自のアプリなどに対して割り当てられる。クライアントがリクエストを送信する時、またレスポンスを受信する時に用いられる。

#### ・動的／非公式ポート番号（49152 ～ 65535）

  自由に使用できるポート番号。クライアントがリクエストを送信する時、またレスポンスを受信する時に用いられる。

#### ・ポートフォワーディング（ポート転送）

サーバ内の特定のポート番号のアプリケーションに対して、パケットが送信されてきた時、これを異なるポート番号のアプリケーションに転送すること。SSHプロトコルと組み合わせると、SSHポートフォワーディングを実現できる。

<br>

### ポートスキャナ

#### ・ポートスキャナとは

ポートスキャナを用いることによって、各ポート番号にアクセスし、応答があるかどうかや、どのようなソフトウェアが応答するかを調べ、一覧表示できる。

<br>

## 05. TCPインターネット層

### インターネット層とは

IPパケットのヘッダ情報を用いて、宛先認識する。

1. PC-Aは、構成したIPパケットをEthernetに乗せて、ルータAに送信。
2. ルータAは、IPパケットをデジタル専用線に乗せて、ルータBに送信。
3. ルータBは、構成したIPパケットをEthernetに乗せて、Webサーバに送信。

![ネットワークにおけるTCP_IPを用いたデータ通信](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ネットワークにおけるTCP_IPを用いたデータ通信.png)

<br>

### IPv4アドレスの種類

![プライベートIPアドレスとグローバルIPアドレス](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プライベートIPアドレスとグローバルIPアドレス.png)

#### ・プライベートIPアドレス

LAN内で用いられる。異なるプライベートネットワーク間では、同じIPv4アドレスが存在する。プライベートIPアドレスは、『```10.0.0.0``` ～ ```10.255.255.255```』、『```172.16.0.0``` ～ ```172.31.255.255```』、『```192.168.0.0``` ～ ```192.168.255.255```』で表される。

#### ・グローバルIPアドレス

プロバイダが提供するIPv4アドレスである。パブリックネットワーク内に同じIPv4アドレスは存在せず、Network Information Centerへの使用申請が必要。プライベートIPアドレスの番号でなければ、グローバルIPアドレスである。NATはグローバルIPアドレスを持っており、プライベートネットワークとプライベートネットワーク間の双方向への通信時に、プライベートIPアドレスと相互変換する。

  <br>

### プライベート／グローバルIPアドレスとbitとの関係

例えば、プライベートIPアドレスの４つのオクテット（第一オクテットから第四オクテットまで）が１Byteの容量をもち、IPアドレス全体で４Byteの容量を持つ。ちなみに、```172```から始まるIPアドレスは、クラスBである。　

![IPアドレスとbitの関係](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/IPアドレスとbitの関係.png)

<br>

### プライベート／グローバルIPアドレスのネットワーク部とホスト部

![IPアドレスのホスト部とネットワーク部](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/IPアドレスのホスト部とネットワーク部.png)

#### ・クラスによるホスト部とネットワーク部の定義

IPアドレスをクラスとして分類し、各クラスでIPアドレスのネットワーク部とホスト部を定義する方法。設定したIPアドレスの属するクラスによって、使用できるIPアドレスの範囲が決まってしまう。ホスト部とネットワーク部の定義方法が4種類しかないため、IPアドレスのパターン数（最大パソコン数）が多すぎたり、少なすぎたりしてしまう。

|         使用可能なIPアドレスの範囲         | クラス | ネットワーク部のオクテット | ホスト部のオクテット |          二進数で見た時（n：ネ、h：ホ）          | IPアドレスのパターン数（最大パソコン数） | 備考 |
| :------------------------------: | :------------: | :---------------------------------: | ---------------------- | :--------------------: | :--------------------: | :--------------------: |
| ```0.0.0.0``` 〜 ```127.255.255.255``` |       A        |         第一のみ         |         第二から第四         | ```0nnnnnnn.hhhhhhhh.hhhhhhhh.hhhhhhhh``` |       2^24（16777216）個       |              |
|   ```128.0.0.0``` 〜 ```191.255.255.255```   |       B        |         第一から第二         |         第三から第四         | ```10nnnnnn.nnnnnnnn.hhhhhhhh.hhhhhhhh``` |        2^16（65536）個        |        よく使う        |
|   ```192.0.0.0``` 〜 ```223.255.255.255```   |       C        |         第一から第三         |         第四のみ         | ```110nnnnn.nnnnnnnn.nnnnnnnn.hhhhhhhh``` |         2^8（256）個         |                  |
|   ```224.0.0.0``` 〜 ```239.255.255.255```   |       D        |           -           |           -            | ```1110xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx``` |           -            |                       |
|   ```240.0.0.0``` 〜 ```255.255.255.255```   |       E        |           -           |           -            | ```1111xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx``` |           -            |                       |

#### ・サブネットマスクよるネットワーク部とホスト部の定義

『```1```』あるいは『```0```』で、IPアドレスのネットワーク部とホスト部を定義し、IPアドレスの後ろに記述する方法（**＊例＊**```192.168.42.23/24```）。設定したIPアドレスに対して、使用可能なIPアドレスの範囲を自由に定義できる。ネットワーク部を『```1```』、ホスト部を『```0```』で表現する。サブネットマスクの表記方法には、二進数形式、IPアドレス形式、```1```の個数で表すCIDR形式による表現方法がある。

|               二進数<br>形式               |   IPアドレス<br>形式   | CIDR<br>形式 | IPアドレスの<br>パターン数<br>（最大PC数） | 備考         |
| :----------------------------------------: | :--------------------: | :----------: | :----------------------------------------: | ------------ |
| ```/10000000.00000000.00000000.00000000``` |    ```/128.0.0.0```    |   ```/1```   |                                            |              |
| ```/11000000.00000000.00000000.00000000``` |    ```/192.0.0.0```    |   ```/2```   |                                            |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.00000000.00000000.00000000``` |    ```/255.0.0.0```    |   ```/8```   |           2^24<br>（16777216）個           |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.11111110.00000000.00000000``` |   ```/255.254.0.0```   |  ```/15```   |                                            |              |
| ```/11111111.11111111.00000000.00000000``` |   ```/255.255.0.0```   |  ```/16```   |            2^16<br>（65536）個             | よく使う範囲 |
|                                            |          ...           |     ...      |                                            |              |
| ```/11111111.11111111.11111110.00000000``` |  ```/255.255.254.0```  |  ```/23```   |                                            |              |
| ```/11111111.11111111.11111111.00000000``` |  ```/255.255.255.0```  |  ```/24```   |              2^8<br>（256）個              |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.11111111.11111111.11111110``` | ```/255.255.255.254``` |  ```/31```   |                                            |              |
| ```/11111111.11111111.11111111.11111111``` | ```/255.255.255.255``` |  ```/32```   |                    1個                     | よく使う範囲 |

**＊例＊**

プライベートIPアドレスが```192.168.0.0```（```11000000.10101000.00000000.00000000```）で、使いたいIPアドレスのパターン数が65536個、または16777216個の場合、サブネットマスクの表記、使用可能なIPアドレスの範囲は以下のようになる。

| 使いたいIPアドレスのパターン数 |                 二進数形式による表記                  |          IPアドレス形式           |       CIDR形式       |      |         使用可能なIPアドレスの範囲          |
| ------------------------------ | :---------------------------------------------------: | :-------------------------------: | :------------------: | ---- | :-----------------------------------------: |
| 16777216個                     | ```192.168.0.0/11111111.00000000.00000000.00000000``` |    ```192.168.0.0/255.0.0.0```    | ```192.168.0.0/24``` | ⇒    |  ```192.168.0.1``` 〜 ```192.168.0.254```   |
| 65536個                        | ```192.168.0.0/11111111.11111111.00000000.00000000``` |   ```192.168.0.0/255.255.0.0```   | ```192.168.0.0/16``` | ⇒    | ```192.168.0.1``` 〜  ```192.168.255.254``` |
| 1個                            | ```192.168.0.0/11111111.11111111.11111111.11111111``` | ```192.168.0.0/255.255.255.255``` | ```192.168.0.0/32``` | ⇒    |              ```192.168.0.0```              |

<br>

### DNSサーバと```hosts```ファイルの役割

#### ・完全修飾ドメイン名とグローバルIPアドレスのマッピング

![IPアドレスと完全修飾ドメイン名のマッピング1](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/IPアドレスと完全修飾ドメイン名のマッピング4.png)

例えば、外部WebサーバのグローバルIPアドレスが『203.142.205.139』であると知っている場合、URLのプロトコル部分以下を『```203.142.205.139```』としてリクエストすれば、外部Webサーバが提供するウェブサイトにアクセスできる。しかし、グローバルIPアドレスは数字の羅列であるため、人間には覚えにくい。そこで、グローバルIPアドレスの代わりに、完全修飾ドメイン名をURLの一部として用いる。

#### ・```hosts```ファイル

DNSサーバよりも先に参照されるマッピングファイル。WebサーバのIPアドレスがDNSサーバに登録されていない時、またDNSサーバが不具合の時に、DNSサーバの代わりとして用いる。

<br>

## 05-02. ルータ

### NAT（静的NAT）：Network Address TranslationによるIPアドレスv4の変換

１つのグローバルIPアドレスに対して、１つのプライベートIPアドレスを紐付けられる。グローバルIPアドレスを持ち、グローバルネットワークとプライベートネットワークの双方向への通信時に、IPアドレスを変換できる。

#### ・リクエスト時のルータにおける変換

プライベートネットワークから出る時に、パケットのヘッダ情報における『送信元』のプライベートIPアドレスをグローバルIPアドレスに変換する。

  **＊例＊**

例えば、GoogleでWebページを見ながら、Gmailアプリを起動している場合、リクエストにおけるパケット情報として…

| 送信元プライベートIPアドレス |  ⇄   | 送信元グローバルIPアドレス |
| :--------------------------: | :--: | :------------------------: |
|      ```192.168.1.1```       |      |      ```200.1.1.1```       |

1. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『メールサーバの待ち受けポート番号```110```（POP3）』を指定して、メールサーバにリクエスト。

```http
GET http://www.example.co.jp:110/
```

2. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『Webサーバの待ち受けポート番号```80```（HTTP）』を指定して、Webサーバにリクエスト。ただし。```80```は、省略可能。

```http
GET http://www.example.co.jp:80/
```

3. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『DNSサーバの待ち受けポート番号```53```（DNS）』を指定して、DNSサーバにリクエスト

```http
GET http://www.example.co.jp:53/
```

4. これらの『送信元プライベートIPアドレス』が、NATルータで、グローバルIPアドレスに変換される。

![プライベートからグローバルへのnat変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プライベートからグローバルへのnat変換.png)

#### ・レスポンス時の変換

プライベートネットワークに入る時に、パケットのヘッダ情報における『宛先』のグローバルIPアドレスをプライベートIPアドレスに変換する。

![グローバルからプライベートへのnat変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/グローバルからプライベートへのnat変換.png)

<br>

### NAPT（動的NAT）：Network Address Port TranslationによるIPアドレスとポート番号の変換

１つのグローバルIPアドレスに対して、複数のプライベートIPアドレスを紐付けられる。グローバルネットワークとプライベートネットワークの双方向への通信時に、IPアドレスを変換できる。

#### ・リクエスト時の変換

プライベートネットワークから出る時に、パケットのヘッダ情報における『送信元』のプライベートIPアドレスをグローバルIPアドレスに変換する。ただし、異なるプライベートIPアドレスが同じグローバルIPに変換されてしまうため、これを識別するために、ポート番号を複数の異なるポート番号に変換し、グローバルIPアドレスに付け加える。

  **＊例＊**

| 送信元プライベートIPアドレス | 変換前ポート番号 |  ⇄   | 送信元グローバルIPアドレス | 変換後ポート番号 |
| :--------------------------: | :--------------: | :--: | :------------------------: | :--------------: |
|      ```192.168.2.1```       |   ```50011```    |      |   ```130.X.X.X:50011```    |   ```50011```    |
|      ```192.168.3.1```       |   ```50011```    |      |   ```130.X.X.X:50012```    |   ```50012```    |

![napt変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/napt変換.png)

#### ・レスポンス時の変換

プライベートネットワークに入る時に、付け加えられたポート番号を元に、パケットのヘッダ情報における『宛先』のグローバルIPアドレスを、異なるプライベートIPアドレスに変換し分ける。

![napt変換_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/napt変換_2.png)

<br>
